<div class="question-panel"
     tabindex="0"
     (keydown)="onQuestionPanelKeydown($event)"
     (focus)="initQuestionKeyboardFocus()"
     (blur)="resetQuestionKeyboardFocus()">
  <div class="keyboard-hint">
    <span><kbd>↑↓</kbd> Navigate</span>
    <span><kbd>Space</kbd> Select</span>
    <span><kbd>⌘↵</kbd> Submit</span>
    <span><kbd>Esc</kbd> Cancel</span>
  </div>
  @if (message.pendingQuestion!.context) {
    <div class="question-context">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
      {{ message.pendingQuestion!.context }}
    </div>
  }
  @for (q of message.pendingQuestion!.questions; track q.id; let qIndex = $index) {
    <div class="question-item" [class.focused]="focusedQuestionIndex() === qIndex">
      <label class="question-label">
        {{ q.text }}
        @if (q.required) {
          <span class="required-mark">*</span>
        }
      </label>

      @if (q.type === 'radio' && q.options) {
        <div class="question-options">
          @for (opt of q.options; track opt.value; let oIndex = $index) {
            <label class="option-label radio-option"
                   [class.recommended]="opt.recommended"
                   [class.keyboard-focused]="isOptionFocused(qIndex, oIndex)">
              <input
                type="radio"
                [name]="q.id"
                [value]="opt.value"
                [checked]="message.pendingQuestion!.answers[q.id] === opt.value"
                (change)="updateQuestionAnswer(q.id, opt.value)" />
              <span class="option-check"></span>
              <span class="option-text">
                {{ opt.label }}
                @if (opt.recommended) {
                  <span class="recommended-badge">Recommended</span>
                }
              </span>
            </label>
          }
        </div>
      }

      @if (q.type === 'checkbox' && q.options) {
        <div class="question-options">
          @for (opt of q.options; track opt.value; let oIndex = $index) {
            <label class="option-label checkbox-option"
                   [class.recommended]="opt.recommended"
                   [class.keyboard-focused]="isOptionFocused(qIndex, oIndex)">
              <input
                type="checkbox"
                [checked]="isCheckboxOptionSelected(q.id, opt.value)"
                (change)="toggleCheckboxOption(q.id, opt.value)" />
              <span class="option-check"></span>
              <span class="option-text">
                {{ opt.label }}
                @if (opt.recommended) {
                  <span class="recommended-badge">Recommended</span>
                }
              </span>
            </label>
          }
        </div>
      }

      @if (q.type === 'text') {
        <textarea
          class="question-text-input"
          [class.keyboard-focused]="isTextInputFocused(qIndex)"
          [placeholder]="q.placeholder || 'Type your answer...'"
          [value]="message.pendingQuestion!.answers[q.id] || ''"
          (input)="updateQuestionAnswer(q.id, $any($event.target).value)"
          (focus)="focusedQuestionIndex.set(qIndex); focusedOptionIndex.set(-1)">
        </textarea>
      }

      @if (q.type === 'color') {
        <div class="question-color-input">
          <div class="color-preview-wrapper">
            <input
              type="color"
              [value]="message.pendingQuestion!.answers[q.id] || q.default || '#3ecf8e'"
              (input)="updateQuestionAnswer(q.id, $any($event.target).value)"
              (focus)="focusedQuestionIndex.set(qIndex); focusedOptionIndex.set(-1)" />
            <div class="color-preview" [style.background]="message.pendingQuestion!.answers[q.id] || q.default || '#3ecf8e'"></div>
          </div>
          <input
            type="text"
            class="color-hex-input"
            [value]="message.pendingQuestion!.answers[q.id] || q.default || '#3ecf8e'"
            (input)="updateQuestionAnswer(q.id, $any($event.target).value)"
            placeholder="#000000" />
        </div>
      }

      @if (q.type === 'range') {
        <div class="question-range-input">
          <input
            type="range"
            [min]="q.min ?? 0"
            [max]="q.max ?? 100"
            [step]="q.step ?? 1"
            [value]="message.pendingQuestion!.answers[q.id] ?? q.default ?? q.min ?? 0"
            (input)="updateQuestionAnswer(q.id, +$any($event.target).value)"
            (focus)="focusedQuestionIndex.set(qIndex); focusedOptionIndex.set(-1)" />
          <div class="range-value">
            <span class="range-number">{{ message.pendingQuestion!.answers[q.id] ?? q.default ?? q.min ?? 0 }}</span>
            @if (q.unit) {
              <span class="range-unit">{{ q.unit }}</span>
            }
          </div>
          <div class="range-bounds">
            <span>{{ q.min ?? 0 }}</span>
            <span>{{ q.max ?? 100 }}</span>
          </div>
        </div>
      }

      @if (q.type === 'image') {
        <div class="question-image-input">
          @if (q.options && q.options.length > 0) {
            <div class="image-options">
              @for (opt of q.options; track opt.value; let oIndex = $index) {
                <div
                  class="image-option"
                  [class.selected]="message.pendingQuestion!.answers[q.id] === opt.value"
                  [class.keyboard-focused]="isOptionFocused(qIndex, oIndex)"
                  (click)="updateQuestionAnswer(q.id, opt.value)">
                  @if (opt.preview) {
                    <img [src]="opt.preview" [alt]="opt.label" />
                  } @else {
                    <div class="image-placeholder">
                      <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" fill="none">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                      </svg>
                    </div>
                  }
                  <span class="image-label">{{ opt.label }}</span>
                  @if (opt.recommended) {
                    <span class="recommended-badge">Recommended</span>
                  }
                </div>
              }
            </div>
          }
          @if (q.allowUpload) {
            <div class="image-upload-area">
              <input
                type="file"
                accept="image/*"
                (change)="handleQuestionImageUpload($event, q.id)"
                #imageUploadInput
                style="display: none" />
              <button class="btn-upload-image" (click)="imageUploadInput.click()">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Image
              </button>
            </div>
          }
          @if (isCustomUploadedImage(q)) {
            <div class="uploaded-image-preview">
              <img [src]="message.pendingQuestion!.answers[q.id]" alt="Uploaded" />
              <button class="btn-remove-upload" (click)="updateQuestionAnswer(q.id, '')">×</button>
            </div>
          }
        </div>
      }

      @if (q.type === 'code') {
        <div class="question-code-input">
          @if (q.language) {
            <div class="code-language-badge">{{ q.language }}</div>
          }
          <textarea
            class="code-textarea"
            [class.keyboard-focused]="isTextInputFocused(qIndex)"
            [placeholder]="q.placeholder || 'Enter code...'"
            [value]="message.pendingQuestion!.answers[q.id] || ''"
            (input)="updateQuestionAnswer(q.id, $any($event.target).value)"
            (focus)="focusedQuestionIndex.set(qIndex); focusedOptionIndex.set(-1)"
            spellcheck="false">
          </textarea>
        </div>
      }
    </div>
  }
  <div class="question-actions">
    @if (hasDefaultAnswers()) {
      <button
        class="btn-accept-defaults"
        (click)="acceptDefaults()"
        title="Accept all recommended/default values">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        Accept Defaults
      </button>
    }
    <button
      class="btn-question-submit"
      [disabled]="!canSubmitQuestions()"
      (click)="submitQuestionAnswers()">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="20 6 9 17 4 12"></polyline></svg>
      Submit
    </button>
    <button class="btn-question-cancel" (click)="cancelQuestion()">
      Cancel
    </button>
  </div>
</div>
