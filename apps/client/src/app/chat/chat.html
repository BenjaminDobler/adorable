@if (visualEditorData()) {
  <div class="visual-editor-panel" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; height: 100%;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; color: var(--text-primary);">Properties</h3>
      <button (click)="closeVisualEditor()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">✕</button>
    </div>
    
    <div class="target-card" style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 1rem; border-radius: 8px;">
      <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Selected Element</div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span style="color: var(--accent-color); font-family: monospace;">&lt;{{ visualEditorData().tagName }}&gt;</span>
        @if (visualEditorData().componentName) {
          <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">{{ visualEditorData().componentName }}</span>
        }
      </div>
    </div>

    <!-- Text Edit -->
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <label style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Content</label>
      <div style="display: flex; gap: 8px;">
        <input 
          [(ngModel)]="editText" 
          (keydown.enter)="applyVisualEdit('text', editText)"
          placeholder="Element text..."
          style="flex: 1; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-primary); padding: 8px; border-radius: 4px;"
        />
        <button (click)="applyVisualEdit('text', editText)" class="btn-icon" title="Apply Text">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </button>
      </div>
    </div>

    <!-- Color Edit -->
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <label style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Text Color</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <input 
          type="color" 
          [(ngModel)]="editColor"
          (change)="applyVisualEdit('style', editColor, 'color')"
          style="width: 40px; height: 40px; border: none; background: none; cursor: pointer;"
        />
        <input 
          [(ngModel)]="editColor"
          (keydown.enter)="applyVisualEdit('style', editColor, 'color')"
          placeholder="#000000" 
          style="flex: 1; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-primary); padding: 8px; border-radius: 4px; font-family: monospace;"
        />
      </div>
    </div>

    <!-- AI Helper Fallback -->
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--panel-border);">
      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Need more complex changes?</div>
      <div style="display: flex; gap: 0.5rem;">
        <textarea 
          [(ngModel)]="visualPrompt" 
          placeholder="Ask AI to change layout, add classes..."
          style="flex: 1; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-primary); padding: 8px; border-radius: 4px; resize: none; height: 60px; font-size: 0.85rem;"
        ></textarea>
      </div>
      <button (click)="applyVisualChanges(visualPrompt)" class="btn-generate" style="width: 100%; margin-top: 8px; border-radius: 4px; height: 32px; font-size: 0.85rem;">
        Apply with AI
      </button>
    </div>

  </div>
} @else {
  <div class="chat-messages" #scrollContainer>
    @for (msg of messages(); track msg) {
      <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'" [class.system]="msg.role === 'system'">
        @if (msg.role === 'assistant') {
          <div class="assistant-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <img src="logo.png" style="width: 16px; height: 16px; object-fit: contain;" />
            <span style="font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Adorable AI</span>
          </div>
        }
        <div class="message-content">
          {{ msg.text }}
          
          @if (msg.updatedFiles && msg.updatedFiles.length > 0) {
            <div class="updated-files-container" style="margin-top: 1rem; border: 1px solid var(--panel-border); border-radius: 6px; overflow: hidden;">
              <button (click)="msg.isExpanded = !msg.isExpanded" style="width: 100%; text-align: left; padding: 8px 12px; background: rgba(0,0,0,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: var(--text-secondary); font-size: 0.8rem; transition: background 0.2s;">
                <span style="font-weight: 600;">Updated files ({{ msg.updatedFiles.length }})</span>
                <svg [style.transform]="msg.isExpanded ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.2s;" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </button>
              @if (msg.isExpanded) {
                <div style="padding: 8px 12px; background: rgba(0,0,0,0.1); border-top: 1px solid var(--panel-border);">
                  @for (file of msg.updatedFiles; track file) {
                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--accent-color); padding: 4px 0; display: flex; align-items: center; gap: 6px;">
                      <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                      {{ file }}
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (msg.files) {
            <div class="message-actions">
              <button class="btn-restore" (click)="restoreVersion(msg.files)" title="Restore project to this state">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                Restore this version
              </button>
            </div>
          }
        </div>
        
        @if (msg.status) {
           <div class="message-status" style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.8; font-style: italic; display: flex; align-items: center; gap: 8px; padding-left: 4px;">
              <div class="spinner-tiny"></div>
              {{ msg.status }}
           </div>
        }

        <div class="message-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            @if (msg.usage) {
              <div class="message-usage" style="font-size: 9px; opacity: 0.4; font-family: monospace;">
                IN: {{ msg.usage.inputTokens }} | OUT: {{ msg.usage.outputTokens }}
              </div>
            }
            @if (msg.model) {
              <div class="message-model" style="font-size: 9px; opacity: 0.6; font-family: monospace; color: var(--accent-color); background: rgba(56, 189, 248, 0.1); padding: 1px 4px; border-radius: 4px;">
                {{ msg.model }}
              </div>
            }
          </div>
          <div class="message-time" style="font-size: 10px; opacity: 0.3;">
            {{ msg.timestamp | date:'shortTime' }}
          </div>
        </div>
      </div>
    }

    @if (messages().length <= 1 && !loading()) {
      <div class="quick-starters" style="padding: 0 1rem 1rem 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        @for (starter of quickStarters; track starter.label) {
          <button (click)="useQuickStarter(starter.prompt)" class="starter-card" style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 12px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; color: var(--text-primary); display: flex; flex-direction: column; gap: 4px;">
            <div style="font-weight: 600; font-size: 0.85rem; color: var(--accent-color);">{{ starter.label }}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">{{ starter.description }}</div>
          </button>
        }
      </div>
    }

    @if (webContainerService.buildError()) {
      <div class="error-alert" style="margin: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px;">
        <div style="display: flex; gap: 8px; align-items: start; margin-bottom: 0.5rem;">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#ef4444" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          <div>
            <div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">Build Failed</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); opacity: 0.8;">The application failed to compile.</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button (click)="autoRepair(webContainerService.buildError()!)" style="flex: 1; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
            Fix with AI
          </button>
          <button (click)="webContainerService.clearBuildError()" style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
            Dismiss
          </button>
        </div>
      </div>
    }

    @if (loading()) {
      <div class="message assistant loading">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    }
  </div>

  <div class="input-container" 
       [class.dragging]="isDragging"
       (drop)="onDrop($event)"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)">
    
    <textarea 
      [(ngModel)]="prompt" 
      placeholder="Describe what you want to build..."
      [disabled]="loading()"
      (keydown.enter)="$event.preventDefault(); generate()">
    </textarea>
    
    <div class="input-footer">
      <div class="tool-group">
        <!-- Model Selector -->
        <div class="model-selector-wrapper" style="position: relative; display: inline-block; margin-right: 8px;">
          <select 
            [ngModel]="selectedModel()" 
            (ngModelChange)="selectedModel.set($event)"
            style="appearance: none; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border); border-radius: 6px; color: var(--text-secondary); padding: 4px 24px 4px 8px; font-size: 0.75rem; cursor: pointer; outline: none; height: 28px; max-width: 130px;">
            @for (model of availableModels(); track model.id) {
               <option [ngValue]="model">{{ model.name }}</option>
            }
          </select>
          <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary);">
             <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
        </div>

        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,application/pdf,text/*" style="display: none" />
        <button (click)="fileInput.click()" class="tool-btn" title="Attach File" [disabled]="loading()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>
        <button (click)="startSelection.emit()" class="tool-btn" title="Select Area to Edit" [disabled]="!webContainerService.url()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        </button>
      </div>

      @if (attachedFileContent) {
        <div class="image-chip">
          @if (isAttachedImage) {
            <img [src]="attachedFileContent | safeUrl" />
            <label style="font-size: 10px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap;">
              <input type="checkbox" [checked]="shouldAddToAssets()" (change)="shouldAddToAssets.set($any($event.target).checked)">
              Add to assets
            </label>
          } @else {
             <div style="display: flex; align-items: center; gap: 6px; padding: 0 4px; color: var(--text-primary); font-size: 0.8rem;">
               <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
               <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ attachedFile?.name }}</span>
             </div>
          }
          <button class="chip-remove" (click)="removeAttachment()">×</button>
        </div>
      }

      <button (click)="generate()" [disabled]="loading() || !prompt" class="btn-generate">
        @if (loading()) {
          <div class="spinner-small"></div>
        } @else {
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        }
      </button>
    </div>
  </div>
}