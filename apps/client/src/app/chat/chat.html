@if (visualEditorData()) {
  <app-visual-editor-panel
    [visualEditorData]="visualEditorData"
    (closeEditor)="closeVisualEditor()"
    (aiChangeRequested)="onAiChangeRequested($event)">
  </app-visual-editor-panel>
} @else {
  <app-chat-message-list
    #messageList
    [messages]="messages()"
    [loading]="loading()"
    [compactMode]="compactMode()"
    [quickStarters]="quickStarters"
    [buildError]="webContainerService.buildError()"
    [projectImageAssets]="getProjectImageAssets()"
    (restoreVersion)="restoreVersion($event)"
    (useQuickStarter)="useQuickStarter($event)"
    (autoRepair)="autoRepair($event)"
    (dismissError)="webContainerService.clearBuildError()"
    (questionSubmitted)="submitQuestionAnswers($event)"
    (questionCancelled)="cancelQuestion($event)"
    (questionAnswerUpdated)="updateQuestionAnswer($event)"
    (questionCheckboxToggled)="toggleCheckboxOption($event)"
    (questionDefaultsAccepted)="acceptDefaults($event)">
  </app-chat-message-list>

  <app-chat-input
    #chatInput
    [loading]="loading()"
    [prompt]="prompt"
    [attachedFileContent]="attachedFileContent"
    [attachedFile]="attachedFile"
    [isAttachedImage]="isAttachedImage"
    [shouldAddToAssets]="shouldAddToAssets()"
    [hasFigmaAttachment]="hasFigmaAttachment"
    [figmaFrameCount]="figmaFrameCount"
    [figmaImages]="figmaImages()"
    [planMode]="planMode()"
    [compactMode]="compactMode()"
    [aiSettingsOpen]="aiSettingsOpen()"
    [mcpToolsVisible]="mcpToolsVisible()"
    [mcpToolsCount]="mcpTools().length"
    (generateRequested)="generate()"
    (cancelGeneration)="cancelGeneration()"
    (promptChange)="prompt = $event"
    (fileSelected)="onFileSelected($event)"
    (removeAttachment)="removeAttachment()"
    (removeFigmaAttachment)="removeFigmaAttachment()"
    (toggleAiSettings)="toggleAiSettings($event)"
    (togglePlanMode)="planMode.set(!planMode())"
    (toggleCompactMode)="compactMode.set(!compactMode())"
    (toggleMcpTools)="toggleMcpTools()"
    (previewImage)="previewImageUrl.set($event)"
    (shouldAddToAssetsChange)="shouldAddToAssets.set($event)">
  </app-chat-input>
}

<!-- AI Settings Popover (fixed position to escape stacking contexts) -->
<app-ai-settings-popover
  [isOpen]="aiSettingsOpen()"
  [position]="aiSettingsPosition()"
  [availableModels]="availableModels()"
  [selectedModel]="selectedModel()"
  [availableSkills]="availableSkills()"
  [selectedSkill]="selectedSkill()"
  [reasoningEffort]="reasoningEffort()"
  (closed)="closeAiSettings()"
  (modelChanged)="selectedModel.set($event)"
  (skillChanged)="selectedSkill.set($event)"
  (reasoningEffortChanged)="reasoningEffort.set($event)">
</app-ai-settings-popover>

<!-- MCP Tools Panel -->
<app-mcp-tools-panel
  [visible]="mcpToolsVisible()"
  [loading]="mcpToolsLoading()"
  [servers]="mcpServers()"
  [tools]="mcpTools()"
  (closed)="mcpToolsVisible.set(false)">
</app-mcp-tools-panel>

<!-- Image Preview Modal (at root level to avoid event bubbling issues) -->
@if (previewImageUrl()) {
  <div class="image-preview-modal" (click)="previewImageUrl.set(null)">
    <div class="image-preview-content" (click)="$event.stopPropagation()">
      <img [src]="previewImageUrl() | safeUrl" />
      <button class="image-preview-close" (click)="$event.stopPropagation(); previewImageUrl.set(null)">Ã—</button>
    </div>
  </div>
}
