@if (visualEditorData()) {
  <div class="visual-editor-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 700; letter-spacing: -0.02em;">Properties</h3>
      <button (click)="closeVisualEditor()" class="tool-btn" style="width: 24px; height: 24px;">✕</button>
    </div>
    
    <div class="target-card" style="background: var(--bg-surface-2); border: 1px solid var(--panel-border); padding: 1rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
      <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 0.75rem;">Selected Element</div>
      <div style="display: flex; gap: 0.75rem; align-items: center;">
        <span style="color: var(--accent-color); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600;">&lt;{{ visualEditorData().tagName }}&gt;</span>
        @if (visualEditorData().componentName) {
          <span style="background: var(--bg-surface-3); color: var(--text-secondary); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; border: 1px solid var(--panel-border);">{{ visualEditorData().componentName }}</span>
        }
      </div>
    </div>

    <!-- Text Edit -->
    <div style="display: flex; flex-direction: column; gap: 0.625rem; margin-top: 0.5rem;">
      <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Content</label>
      <div style="display: flex; gap: 10px;">
        <input 
          [(ngModel)]="editText" 
          (keydown.enter)="applyVisualEdit('text', editText)"
          placeholder="Element text..."
        />
        <button (click)="applyVisualEdit('text', editText)" class="btn-apply" title="Apply Text">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </button>
      </div>
    </div>

    <!-- Color Edit -->
    <div style="display: flex; flex-direction: column; gap: 0.625rem; margin-top: 0.5rem;">
      <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Text Color</label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <div style="position: relative; width: 42px; height: 42px; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--panel-border); flex-shrink: 0;">
          <input 
            type="color" 
            [(ngModel)]="editColor"
            (change)="applyVisualEdit('style', editColor, 'color')"
            style="position: absolute; top: -5px; left: -5px; width: 60px; height: 60px; border: none; background: none; cursor: pointer; padding: 0;"
          />
        </div>
        <input 
          [(ngModel)]="editColor"
          (keydown.enter)="applyVisualEdit('style', editColor, 'color')"
          placeholder="#000000" 
          style="font-family: 'JetBrains Mono', monospace;"
        />
      </div>
    </div>

    <!-- AI Helper Fallback -->
    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--panel-border);">
      <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">AI Modification</div>
      <div class="input-container" style="margin: 0; box-shadow: none;">
        <textarea 
          [(ngModel)]="visualPrompt" 
          placeholder="Ask AI to change layout, add classes..."
          style="height: 80px;"
        ></textarea>
      </div>
      <button (click)="applyVisualChanges(visualPrompt)" class="btn-generate" style="width: 100%; margin-top: 12px; height: 38px; font-size: 0.85rem; font-weight: 700; border-radius: var(--radius-md);">
        ✨ Apply with AI
      </button>
    </div>

  </div>
} @else {
  <div class="chat-messages" #scrollContainer>
    @for (msg of messages(); track msg) {
      <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'" [class.system]="msg.role === 'system'">
        @if (msg.role === 'assistant') {
          <div class="assistant-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; padding-left: 4px;">
            <img src="logo.png" style="width: 16px; height: 16px; object-fit: contain; filter: drop-shadow(0 0 5px var(--accent-glow));" />
            <span style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Adorable AI</span>
          </div>
        }
        <div class="message-content">
          {{ msg.text }}
          
          @if (msg.updatedFiles && msg.updatedFiles.length > 0) {
            <div class="updated-files-container" style="margin-top: 1.25rem; border: 1px solid var(--panel-border); border-radius: var(--radius-md); overflow: hidden; background: rgba(0,0,0,0.1);">
              <button (click)="msg.isExpanded = !msg.isExpanded" style="width: 100%; text-align: left; padding: 10px 12px; background: var(--bg-surface-2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: var(--text-secondary); font-size: 0.8rem; transition: background 0.2s;">
                <span style="font-weight: 700;">Updated files ({{ msg.updatedFiles.length }})</span>
                <svg [style.transform]="msg.isExpanded ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </button>
              @if (msg.isExpanded) {
                <div style="padding: 8px 12px; background: var(--bg-surface-1); border-top: 1px solid var(--panel-border);">
                  @for (file of msg.updatedFiles; track file) {
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-color); padding: 6px 0; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                      {{ file }}
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (msg.files) {
            <div class="message-actions">
              <button class="btn-restore" (click)="restoreVersion(msg.files)" title="Restore project to this state">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                Restore version
              </button>
            </div>
          }
        </div>
        
        @if (msg.status) {
           <div class="message-status" style="margin-top: 10px; font-size: 0.75rem; color: var(--accent-color); font-weight: 600; display: flex; align-items: center; gap: 10px; padding-left: 8px;">
              <div class="spinner-tiny" style="border-top-color: var(--accent-color);"></div>
              {{ msg.status }}
           </div>
        }

        <div class="message-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; padding: 0 4px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            @if (msg.usage) {
              <div class="message-usage" style="font-size: 9px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-weight: 500;">
                {{ msg.usage.inputTokens }} IN / {{ msg.usage.outputTokens }} OUT
              </div>
            }
            @if (msg.model) {
              <div class="message-model" style="font-size: 9px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-color); background: var(--accent-glow); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--panel-border-glow);">
                {{ msg.model }}
              </div>
            }
          </div>
          <div class="message-time" style="font-size: 10px; color: var(--text-muted); font-weight: 500;">
            {{ msg.timestamp | date:'shortTime' }}
          </div>
        </div>
      </div>
    }

    @if (messages().length <= 1 && !loading()) {
      <div class="quick-starters" style="padding: 0 1.25rem 1.25rem 1.25rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        @for (starter of quickStarters; track starter.label) {
          <button (click)="useQuickStarter(starter.prompt)" class="starter-card" style="background: var(--bg-surface-2); border: 1px solid var(--panel-border); padding: 16px; border-radius: var(--radius-lg); text-align: left; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: var(--text-primary); display: flex; flex-direction: column; gap: 6px; box-shadow: var(--shadow-sm);">
            <div style="font-weight: 700; font-size: 0.9rem; color: var(--accent-color); letter-spacing: -0.01em;">{{ starter.label }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.5; font-weight: 500;">{{ starter.description }}</div>
          </button>
        }
      </div>
    }

    @if (webContainerService.buildError()) {
      <div class="error-alert" style="margin: 1.25rem; padding: 1.25rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 1rem;">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="var(--error-color)" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          <div>
            <div style="color: var(--error-color); font-weight: 700; font-size: 0.95rem; letter-spacing: -0.01em; margin-bottom: 4px;">Build Failed</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">The application failed to compile.</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button (click)="autoRepair(webContainerService.buildError()!)" style="flex: 1; background: var(--error-color); color: white; border: none; padding: 8px 12px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">
            ✨ Fix with AI
          </button>
          <button (click)="webContainerService.clearBuildError()" style="background: var(--bg-surface-3); border: 1px solid var(--panel-border); color: var(--text-secondary); padding: 8px 12px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 600; cursor: pointer;">
            Dismiss
          </button>
        </div>
      </div>
    }

    @if (loading()) {
      <div class="message assistant loading" style="background: transparent;">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    }
  </div>

  <div class="input-container" 
       [class.dragging]="isDragging"
       (drop)="onDrop($event)"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)">
    
    <textarea 
      [(ngModel)]="prompt" 
      placeholder="Describe what you want to build..."
      [disabled]="loading()"
      (keydown.enter)="$event.preventDefault(); generate()">
    </textarea>
    
    <div class="input-footer">
      <div class="tool-group">
        <!-- Model Selector -->
        <div class="model-selector-wrapper" style="position: relative; display: inline-block; margin-right: 8px;">
          <select 
            [ngModel]="selectedModel()" 
            (ngModelChange)="selectedModel.set($event)"
            style="appearance: none; background: var(--bg-surface-3); border: 1px solid var(--panel-border); border-radius: var(--radius-sm); color: var(--text-secondary); padding: 4px 28px 4px 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; outline: none; height: 30px; max-width: 140px; transition: all 0.2s;">
            @for (model of availableModels(); track model.id) {
               <option [ngValue]="model">{{ model.name }}</option>
            }
          </select>
          <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
             <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="3" fill="none"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
        </div>

        @if (isDockerMode()) {
          <button 
            (click)="agentMode.set(!agentMode())" 
            class="tool-btn" 
            [class.active]="agentMode()"
            [title]="agentMode() ? 'Disable Agent Mode' : 'Enable Agent Mode (Full Container Access)'"
            style="margin-right: 8px; position: relative;">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
              <path d="M12 2a10 10 0 0 1 10 10h-10V2z" [style.fill]="agentMode() ? 'var(--accent-color)' : 'none'" [style.opacity]="agentMode() ? '0.3' : '1'"></path>
              <circle cx="12" cy="12" r="3" [style.fill]="agentMode() ? 'var(--accent-color)' : 'none'"></circle>
            </svg>
            @if (agentMode()) {
              <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; box-shadow: 0 0 5px var(--accent-glow);"></span>
            }
          </button>
        }

        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,application/pdf,text/*" style="display: none" />
        <button (click)="fileInput.click()" class="tool-btn" title="Attach File" [disabled]="loading()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>
        <button (click)="startSelection.emit()" class="tool-btn" title="Select Area to Edit" [disabled]="!webContainerService.url()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        </button>
      </div>

      @if (attachedFileContent) {
        <div class="image-chip" style="margin: 0 12px 0 0;">
          @if (isAttachedImage) {
            <img [src]="attachedFileContent | safeUrl" />
            <label style="font-size: 10px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; font-weight: 600; padding-right: 4px;">
              <input type="checkbox" [checked]="shouldAddToAssets()" (change)="shouldAddToAssets.set($any($event.target).checked)">
              Add to assets
            </label>
          } @else {
             <div style="display: flex; align-items: center; gap: 8px; padding: 0 8px; color: var(--text-primary); font-size: 0.8rem; font-weight: 600;">
               <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
               <span style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ attachedFile?.name }}</span>
             </div>
          }
          <button class="chip-remove" (click)="removeAttachment()">×</button>
        </div>
      }

      <button (click)="generate()" [disabled]="loading() || !prompt" class="btn-generate">
        @if (loading()) {
          <div class="spinner-small" style="border-top-color: white; border-width: 2px; width: 14px; height: 14px;"></div>
        } @else {
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        }
      </button>
    </div>
  </div>
}