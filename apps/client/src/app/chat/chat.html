@if (visualEditorData()) {
  <div class="visual-editor-panel" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; height: 100%;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; color: var(--text-primary);">Visual Edit</h3>
      <button (click)="closeVisualEditor()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">✕</button>
    </div>
    
    <div class="target-card" style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 1rem; border-radius: 8px;">
      <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Target</div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span style="color: var(--accent-color); font-family: monospace;">&lt;{{ visualEditorData().tagName }}&gt;</span>
        @if (visualEditorData().componentName) {
          <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">{{ visualEditorData().componentName }}</span>
        }
      </div>
      @if (visualEditorData().text) {
        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.875rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          "{{ visualEditorData().text }}"
        </div>
      }
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
      <label style="font-size: 0.875rem; font-weight: 500;">What change do you want?</label>
      <textarea 
        [(ngModel)]="visualPrompt" 
        placeholder="e.g. Change text to 'Welcome', make it bold, set background to blue..."
        style="flex: 1; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-primary); padding: 1rem; border-radius: 8px; resize: none;"
      ></textarea>
    </div>

    <button (click)="applyVisualChanges(visualPrompt)" class="btn-generate" style="width: 100%; border-radius: 8px; height: 40px; font-weight: 600;">
      Apply Change
    </button>
  </div>
} @else {
  <div class="chat-messages" #scrollContainer>
    @for (msg of messages(); track msg) {
      <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'" [class.system]="msg.role === 'system'">
        @if (msg.role === 'assistant') {
          <div class="assistant-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <img src="logo.png" style="width: 16px; height: 16px; object-fit: contain;" />
            <span style="font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Adorable AI</span>
          </div>
        }
        <div class="message-content">
          {{ msg.text }}
          @if (msg.files) {
            <div class="message-actions">
              <button class="btn-restore" (click)="restoreVersion(msg.files)" title="Restore project to this state">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                Restore this version
              </button>
            </div>
          }
        </div>
        <div class="message-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
          @if (msg.usage) {
            <div class="message-usage" style="font-size: 9px; opacity: 0.4; font-family: monospace;">
              Tokens: {{ msg.usage.totalTokens }} ({{ msg.usage.inputTokens }} in, {{ msg.usage.outputTokens }} out)
            </div>
          } @else {
            <span></span>
          }
          <div class="message-time">{{ msg.timestamp | date:'shortTime' }}</div>
        </div>
      </div>
    }

    @if (messages().length <= 1 && !loading()) {
      <div class="quick-starters" style="padding: 0 1rem 1rem 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        @for (starter of quickStarters; track starter.label) {
          <button (click)="useQuickStarter(starter.prompt)" class="starter-card" style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 12px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; color: var(--text-primary); display: flex; flex-direction: column; gap: 4px;">
            <div style="font-weight: 600; font-size: 0.85rem; color: var(--accent-color);">{{ starter.label }}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">{{ starter.description }}</div>
          </button>
        }
      </div>
    }

    @if (webContainerService.buildError()) {
      <div class="error-alert" style="margin: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px;">
        <div style="display: flex; gap: 8px; align-items: start; margin-bottom: 0.5rem;">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#ef4444" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          <div>
            <div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">Build Failed</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); opacity: 0.8;">The application failed to compile.</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button (click)="autoRepair(webContainerService.buildError()!)" style="flex: 1; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
            Fix with AI
          </button>
          <button (click)="webContainerService.buildError.set(null)" style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
            Dismiss
          </button>
        </div>
      </div>
    }

    @if (loading()) {
      <div class="message assistant loading">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    }
  </div>

  <div class="input-container" 
       [class.dragging]="isDragging"
       (drop)="onDrop($event)"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)">
    
    <textarea 
      [(ngModel)]="prompt" 
      placeholder="Describe what you want to build..."
      [disabled]="loading()"
      (keydown.enter)="$event.preventDefault(); generate()">
    </textarea>
    
    <div class="input-footer">
      <div class="tool-group">
        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none" />
        <button (click)="fileInput.click()" class="tool-btn" title="Upload Image" [disabled]="loading()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>
        <button (click)="startSelection.emit()" class="tool-btn" title="Select Area to Edit" [disabled]="!webContainerService.url()">
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        </button>
      </div>

      @if (attachedImage) {
        <div class="image-chip">
          <img [src]="attachedImage | safeUrl" />
          <label style="font-size: 10px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap;">
            <input type="checkbox" [checked]="shouldAddToAssets()" (change)="shouldAddToAssets.set($any($event.target).checked)">
            Add to assets
          </label>
          <button class="chip-remove" (click)="removeAttachment()">×</button>
        </div>
      }

      <button (click)="generate()" [disabled]="loading() || !prompt" class="btn-generate">
        @if (loading()) {
          <div class="spinner-small"></div>
        } @else {
          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        }
      </button>
    </div>
  </div>
}