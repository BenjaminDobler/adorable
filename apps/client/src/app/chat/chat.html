@if (visualEditorData()) {
  <div class="visual-editor-panel">
    <div class="panel-header">
      <h3>Properties</h3>
      <button (click)="closeVisualEditor()" class="tool-btn close-btn">‚úï</button>
    </div>

    <!-- Breadcrumb Navigation -->
    @if (visualEditorData().hierarchy && visualEditorData().hierarchy.length > 0) {
      <div class="breadcrumb-nav">
        @for (item of visualEditorData().hierarchy; track $index; let last = $last) {
          <button
            class="breadcrumb-item"
            [class.current]="last"
            (click)="!last && selectFromBreadcrumb(item, $index)"
            [disabled]="last">
            {{ item.tagName }}
          </button>
          @if (!last) {
            <span class="breadcrumb-sep">‚Ä∫</span>
          }
        }
      </div>
    }

    <!-- Selected Element Info -->
    <div class="target-card">
      <div class="section-label">Selected Element</div>
      <div class="element-info">
        <span class="tag-name">&lt;{{ visualEditorData().tagName }}&gt;</span>
        @if (visualEditorData().componentName) {
          <span class="component-badge">{{ visualEditorData().componentName }}</span>
        }
        @if (visualEditorData().elementId) {
          <span class="element-id-badge">{{ visualEditorData().elementId }}</span>
        }
      </div>
      @if (visualEditorData().classes) {
        <div class="classes-info">.{{ visualEditorData().classes.split(' ').slice(0, 3).join(' .') }}</div>
      }
    </div>

    <!-- Content Section -->
    <div class="property-section">
      <div class="section-header">
        <span class="section-icon">üìù</span>
        <span class="section-title">Content</span>
      </div>
      <div class="inline-hint">Double-click element in preview to edit directly</div>
      <div class="input-row">
        <input
          [(ngModel)]="editText"
          (keydown.enter)="applyVisualEdit('text', editText)"
          placeholder="Element text..."
        />
        <button (click)="applyVisualEdit('text', editText)" class="btn-apply" title="Apply">
          <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="3" fill="none"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </button>
      </div>
    </div>

    <!-- Colors Section -->
    <div class="property-section">
      <div class="section-header">
        <span class="section-icon">üé®</span>
        <span class="section-title">Colors</span>
      </div>
      <div class="color-row">
        <label>Text</label>
        <div class="color-input-group">
          <div class="color-swatch">
            <input type="color" [(ngModel)]="editColor" (change)="applyVisualEdit('style', editColor, 'color')" />
          </div>
          <input [(ngModel)]="editColor" (keydown.enter)="applyVisualEdit('style', editColor, 'color')" placeholder="#000000" class="color-value" />
        </div>
      </div>
      <div class="color-row">
        <label>Background</label>
        <div class="color-input-group">
          <div class="color-swatch">
            <input type="color" [(ngModel)]="editBgColor" (change)="applyVisualEdit('style', editBgColor, 'background-color')" />
          </div>
          <input [(ngModel)]="editBgColor" (keydown.enter)="applyVisualEdit('style', editBgColor, 'background-color')" placeholder="transparent" class="color-value" />
        </div>
      </div>
    </div>

    <!-- Typography Section -->
    <div class="property-section">
      <div class="section-header">
        <span class="section-icon">üìê</span>
        <span class="section-title">Typography</span>
      </div>
      <div class="button-group-row">
        <label>Size</label>
        <div class="button-group">
          <button [class.active]="editFontSize === '12px'" (click)="setFontSize('12px')">xs</button>
          <button [class.active]="editFontSize === '14px'" (click)="setFontSize('14px')">sm</button>
          <button [class.active]="editFontSize === '16px'" (click)="setFontSize('16px')">base</button>
          <button [class.active]="editFontSize === '18px'" (click)="setFontSize('18px')">lg</button>
          <button [class.active]="editFontSize === '24px'" (click)="setFontSize('24px')">xl</button>
        </div>
      </div>
      <div class="button-group-row">
        <label>Weight</label>
        <div class="button-group">
          <button [class.active]="editFontWeight === '300'" (click)="setFontWeight('300')">Light</button>
          <button [class.active]="editFontWeight === '400'" (click)="setFontWeight('400')">Normal</button>
          <button [class.active]="editFontWeight === '600'" (click)="setFontWeight('600')">Semi</button>
          <button [class.active]="editFontWeight === '700'" (click)="setFontWeight('700')">Bold</button>
        </div>
      </div>
      <div class="button-group-row">
        <label>Align</label>
        <div class="button-group">
          <button [class.active]="editTextAlign === 'left'" (click)="setTextAlign('left')" title="Left">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
          </button>
          <button [class.active]="editTextAlign === 'center'" (click)="setTextAlign('center')" title="Center">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>
          </button>
          <button [class.active]="editTextAlign === 'right'" (click)="setTextAlign('right')" title="Right">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Spacing Section -->
    <div class="property-section">
      <div class="section-header">
        <span class="section-icon">üì¶</span>
        <span class="section-title">Spacing</span>
      </div>
      <div class="spacing-box-container">
        <div class="spacing-label">Margin</div>
        <div class="spacing-box margin-box">
          <input type="number" class="spacing-top" [(ngModel)]="editMarginTop" (change)="applySpacing('margin-top', editMarginTop)" placeholder="0" />
          <div class="spacing-middle">
            <input type="number" class="spacing-left" [(ngModel)]="editMarginLeft" (change)="applySpacing('margin-left', editMarginLeft)" placeholder="0" />
            <div class="spacing-inner padding-box">
              <input type="number" class="spacing-top" [(ngModel)]="editPaddingTop" (change)="applySpacing('padding-top', editPaddingTop)" placeholder="0" />
              <div class="spacing-middle">
                <input type="number" class="spacing-left" [(ngModel)]="editPaddingLeft" (change)="applySpacing('padding-left', editPaddingLeft)" placeholder="0" />
                <div class="spacing-center"></div>
                <input type="number" class="spacing-right" [(ngModel)]="editPaddingRight" (change)="applySpacing('padding-right', editPaddingRight)" placeholder="0" />
              </div>
              <input type="number" class="spacing-bottom" [(ngModel)]="editPaddingBottom" (change)="applySpacing('padding-bottom', editPaddingBottom)" placeholder="0" />
            </div>
            <input type="number" class="spacing-right" [(ngModel)]="editMarginRight" (change)="applySpacing('margin-right', editMarginRight)" placeholder="0" />
          </div>
          <input type="number" class="spacing-bottom" [(ngModel)]="editMarginBottom" (change)="applySpacing('margin-bottom', editMarginBottom)" placeholder="0" />
        </div>
        <div class="spacing-labels">
          <span class="margin-label">Margin</span>
          <span class="padding-label">Padding</span>
        </div>
      </div>
    </div>

    <!-- Border Section -->
    <div class="property-section">
      <div class="section-header">
        <span class="section-icon">üî≤</span>
        <span class="section-title">Border</span>
      </div>
      <div class="slider-row">
        <label>Radius</label>
        <input type="range" min="0" max="32" [(ngModel)]="editBorderRadius" (input)="applyVisualEdit('style', editBorderRadius + 'px', 'border-radius')" />
        <span class="slider-value">{{ editBorderRadius }}px</span>
      </div>
    </div>

    <!-- Layout Section (for containers) -->
    @if (isContainerElement()) {
      <div class="property-section">
        <div class="section-header">
          <span class="section-icon">üìê</span>
          <span class="section-title">Layout</span>
        </div>
        <div class="button-group-row">
          <label>Display</label>
          <div class="button-group">
            <button [class.active]="editDisplay === 'block'" (click)="setDisplay('block')">Block</button>
            <button [class.active]="editDisplay === 'flex'" (click)="setDisplay('flex')">Flex</button>
            <button [class.active]="editDisplay === 'grid'" (click)="setDisplay('grid')">Grid</button>
          </div>
        </div>
        @if (editDisplay === 'flex') {
          <div class="button-group-row">
            <label>Direction</label>
            <div class="button-group">
              <button [class.active]="editFlexDirection === 'row'" (click)="setFlexDirection('row')" title="Row">‚Üí</button>
              <button [class.active]="editFlexDirection === 'column'" (click)="setFlexDirection('column')" title="Column">‚Üì</button>
              <button [class.active]="editFlexDirection === 'row-reverse'" (click)="setFlexDirection('row-reverse')" title="Row Reverse">‚Üê</button>
              <button [class.active]="editFlexDirection === 'column-reverse'" (click)="setFlexDirection('column-reverse')" title="Column Reverse">‚Üë</button>
            </div>
          </div>
          <div class="button-group-row">
            <label>Justify</label>
            <div class="button-group">
              <button [class.active]="editJustifyContent === 'flex-start'" (click)="setJustifyContent('flex-start')" title="Start">‚¨õ‚¨ú‚¨ú</button>
              <button [class.active]="editJustifyContent === 'center'" (click)="setJustifyContent('center')" title="Center">‚¨ú‚¨õ‚¨ú</button>
              <button [class.active]="editJustifyContent === 'flex-end'" (click)="setJustifyContent('flex-end')" title="End">‚¨ú‚¨ú‚¨õ</button>
              <button [class.active]="editJustifyContent === 'space-between'" (click)="setJustifyContent('space-between')" title="Between">‚¨õ‚¨ú‚¨õ</button>
            </div>
          </div>
          <div class="button-group-row">
            <label>Align</label>
            <div class="button-group">
              <button [class.active]="editAlignItems === 'flex-start'" (click)="setAlignItems('flex-start')" title="Start">‚¨õ</button>
              <button [class.active]="editAlignItems === 'center'" (click)="setAlignItems('center')" title="Center">‚óÜ</button>
              <button [class.active]="editAlignItems === 'flex-end'" (click)="setAlignItems('flex-end')" title="End">‚¨ú</button>
              <button [class.active]="editAlignItems === 'stretch'" (click)="setAlignItems('stretch')" title="Stretch">‚ñÆ</button>
            </div>
          </div>
          <div class="slider-row">
            <label>Gap</label>
            <input type="range" min="0" max="48" [(ngModel)]="editGap" (input)="applyVisualEdit('style', editGap + 'px', 'gap')" />
            <span class="slider-value">{{ editGap }}px</span>
          </div>
        }
      </div>
    }

    <!-- AI Modification -->
    <div class="property-section ai-section">
      <div class="section-header">
        <span class="section-icon">‚ú®</span>
        <span class="section-title">AI Modification</span>
      </div>
      <div class="input-container ai-input">
        <textarea
          [(ngModel)]="visualPrompt"
          placeholder="Describe changes: 'add shadow', 'make it rounded'..."
        ></textarea>
      </div>
      <button (click)="applyVisualChanges(visualPrompt)" class="btn-generate ai-apply-btn">
        ‚ú® Apply with AI
      </button>
    </div>
  </div>
} @else {
  <div class="chat-messages" #scrollContainer>
    @for (msg of messages(); track msg) {
      <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'" [class.system]="msg.role === 'system'">
        @if (msg.role === 'assistant') {
          <div class="assistant-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; padding-left: 4px;">
            <img src="logo.png" style="width: 16px; height: 16px; object-fit: contain; filter: drop-shadow(0 0 5px var(--accent-glow));" />
            <span style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Adorable AI</span>
          </div>
        }
        <div class="message-content">
          <div class="markdown-body" [innerHTML]="msg.text | markdown"></div>

          @if (getActivatedSkills(msg).length > 0) {
             <div class="skill-badges" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--panel-border-glow);">
                @for (skill of getActivatedSkills(msg); track skill) {
                  <span class="skill-indicator" style="font-size: 10px; background: rgba(62, 207, 142, 0.1); color: var(--accent-color); padding: 4px 10px; border-radius: 6px; font-weight: 700; border: 1px solid rgba(62, 207, 142, 0.2); display: flex; align-items: center; gap: 6px; animation: slideIn 0.3s ease-out;">
                    <div style="background: var(--accent-color); color: #000; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px;">‚ö°</div>
                    {{ skill }}
                  </span>
                }
             </div>
          }

          @if (msg.updatedFiles && msg.updatedFiles.length > 0) {
            <div class="updated-files-container" style="margin-top: 1.25rem; border: 1px solid var(--panel-border); border-radius: var(--radius-md); overflow: hidden; background: rgba(0,0,0,0.1);">
              <button (click)="msg.isExpanded = !msg.isExpanded" style="width: 100%; text-align: left; padding: 10px 12px; background: var(--bg-surface-2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: var(--text-secondary); font-size: 0.8rem; transition: background 0.2s;">
                <span style="font-weight: 700;">Updated files ({{ msg.updatedFiles.length }})</span>
                <svg [style.transform]="msg.isExpanded ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </button>
              @if (msg.isExpanded) {
                <div style="padding: 8px 12px; background: var(--bg-surface-1); border-top: 1px solid var(--panel-border);">
                  @for (file of msg.updatedFiles; track file) {
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-color); padding: 6px 0; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                      {{ file }}
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (msg.toolResults && msg.toolResults.length > 0) {
            <div class="tool-results-wrapper" style="margin-top: 1rem;">
               <button (click)="msg.areToolsExpanded = !msg.areToolsExpanded" 
                       class="tool-toggle-btn"
                       style="width: 100%; background: var(--bg-surface-2); border: 1px solid var(--panel-border); padding: 8px 12px; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; transition: background 0.2s;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                     <svg [style.transform]="(msg.areToolsExpanded || !compactMode()) ? 'rotate(180deg)' : 'rotate(0)'" style="transition: transform 0.2s;" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6 9 12 15 18 9"></polyline></svg>
                     <span style="font-weight: 700; font-size: 0.75rem; color: var(--text-secondary);">
                       {{ msg.toolResults.length }} System Actions
                     </span>
                  </div>
                  @if (!msg.areToolsExpanded && compactMode()) {
                     <span style="font-size: 0.7rem; color: var(--text-muted); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'JetBrains Mono', monospace;">
                        Latest: {{ msg.toolResults[msg.toolResults.length - 1].tool }}
                     </span>
                  }
               </button>

               @if (!compactMode() || msg.areToolsExpanded) {
                  <div class="tool-results-container" style="animation: slideIn 0.2s ease-out;">
                    @for (res of msg.toolResults; track res) {
                      <div class="tool-result-item" style="border: 1px solid var(--panel-border); border-radius: var(--radius-md); overflow: hidden; margin-bottom: 0.5rem;">
                        <div style="background: var(--bg-surface-2); padding: 6px 12px; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--panel-border);">
                          <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                          {{ res.tool | uppercase }}
                          @if (res.isError) {
                            <span style="color: var(--error-color); font-size: 0.6rem; margin-left: auto;">FAILED</span>
                          } @else {
                            <span style="color: var(--accent-color); font-size: 0.6rem; margin-left: auto;">SUCCESS</span>
                          }
                        </div>
                        <pre style="margin: 0; padding: 10px; background: #000; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">{{ res.result }}</pre>
                      </div>
                    }
                  </div>
               }
            </div>
          }

          @if (msg.files) {
            <div class="message-actions">
              <button class="btn-restore" (click)="restoreVersion(msg.files)" title="Restore project to this state">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                Restore version
              </button>
            </div>
          }
        </div>
        
        @if (msg.status) {
           <div class="message-status" style="margin-top: 10px; font-size: 0.75rem; color: var(--accent-color); font-weight: 600; display: flex; align-items: center; gap: 10px; padding-left: 8px;">
              <div class="spinner-tiny" style="border-top-color: var(--accent-color);"></div>
              {{ msg.status }}
           </div>
        }

        <div class="message-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; padding: 0 4px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            @if (msg.duration) {
              <div style="font-size: 9px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-weight: 500;">
                {{ msg.duration >= 60000 ? (msg.duration / 60000 | number:'1.1-1') + 'm' : (msg.duration / 1000 | number:'1.0-0') + 's' }}
              </div>
            }
            @if (msg.usage) {
              <div class="message-usage" style="font-size: 9px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-weight: 500;">
                {{ msg.usage.inputTokens }} IN / {{ msg.usage.outputTokens }} OUT
              </div>
            }
            @if (msg.model) {
              <div class="message-model" style="font-size: 9px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-color); background: var(--accent-glow); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--panel-border-glow);">
                {{ msg.model }}
              </div>
            }
          </div>
          <div class="message-time" style="font-size: 10px; color: var(--text-muted); font-weight: 500;">
            {{ msg.timestamp | date:'shortTime' }}
          </div>
        </div>
      </div>
    }

    @if (messages().length <= 1 && !loading()) {
      <div class="quick-starters" style="padding: 0 1.25rem 1.25rem 1.25rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        @for (starter of quickStarters; track starter.label) {
          <button (click)="useQuickStarter(starter.prompt)" class="starter-card" style="background: var(--bg-surface-2); border: 1px solid var(--panel-border); padding: 16px; border-radius: var(--radius-lg); text-align: left; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: var(--text-primary); display: flex; flex-direction: column; gap: 6px; box-shadow: var(--shadow-sm);">
            <div style="font-weight: 700; font-size: 0.9rem; color: var(--accent-color); letter-spacing: -0.01em;">{{ starter.label }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.5; font-weight: 500;">{{ starter.description }}</div>
          </button>
        }
      </div>
    }

    @if (webContainerService.buildError()) {
      <div class="error-alert" style="margin: 1.25rem; padding: 1.25rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
        <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 1rem;">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="var(--error-color)" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          <div>
            <div style="color: var(--error-color); font-weight: 700; font-size: 0.95rem; letter-spacing: -0.01em; margin-bottom: 4px;">Build Failed</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">The application failed to compile.</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button (click)="autoRepair(webContainerService.buildError()!)" style="flex: 1; background: var(--error-color); color: white; border: none; padding: 8px 12px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">
            ‚ú® Fix with AI
          </button>
          <button (click)="webContainerService.clearBuildError()" style="background: var(--bg-surface-3); border: 1px solid var(--panel-border); color: var(--text-secondary); padding: 8px 12px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 600; cursor: pointer;">
            Dismiss
          </button>
        </div>
      </div>
    }

    @if (loading()) {
      <div class="message assistant loading" style="background: transparent;">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    }
  </div>

  <div class="input-container" 
       [class.dragging]="isDragging"
       (drop)="onDrop($event)"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)">
    
    <textarea 
      [(ngModel)]="prompt" 
      placeholder="Describe what you want to build..."
      [disabled]="loading()"
      (keydown.enter)="$event.preventDefault(); generate()">
    </textarea>
    
    <div class="input-footer">
      <div class="tool-group">
        <!-- Model Selector -->
        <div class="model-selector-wrapper" style="position: relative; display: inline-block; margin-right: 8px;">
          <select 
            [ngModel]="selectedModel()" 
            (ngModelChange)="selectedModel.set($event)"
            style="appearance: none; background: var(--bg-surface-3); border: 1px solid var(--panel-border); border-radius: var(--radius-sm); color: var(--text-secondary); padding: 4px 28px 4px 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; outline: none; height: 30px; max-width: 140px; transition: all 0.2s;">
            @for (model of availableModels(); track model.id) {
               <option [ngValue]="model">{{ model.name }}</option>
            }
          </select>
          <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
             <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="3" fill="none"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
        </div>

        <!-- Skill Selector -->
        <div class="skill-selector-wrapper" style="position: relative; display: inline-block; margin-right: 8px;">
          <select 
            [ngModel]="selectedSkill()" 
            (ngModelChange)="selectedSkill.set($event)"
            style="appearance: none; background: var(--bg-surface-3); border: 1px solid var(--panel-border); border-radius: var(--radius-sm); color: var(--text-secondary); padding: 4px 28px 4px 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; outline: none; height: 30px; max-width: 120px; transition: all 0.2s;">
            <option [ngValue]="null">Auto Skill</option>
            @for (skill of availableSkills(); track skill.name) {
               <option [ngValue]="skill">‚ö° {{ skill.name }}</option>
            }
          </select>
          <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
             <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="3" fill="none"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
        </div>

        <button 
          (click)="compactMode.set(!compactMode())" 
          class="tool-btn" 
          [class.active]="compactMode()"
          [title]="compactMode() ? 'Show Full Tool Output' : 'Compact Tool Output'"
          style="margin-right: 8px;">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
        </button>

        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,application/pdf,text/*" style="display: none" />
        <button (click)="fileInput.click()" class="tool-btn" title="Attach File" [disabled]="loading()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>
        <button (click)="startSelection.emit()" class="tool-btn" title="Select Area to Edit" [disabled]="!webContainerService.url()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        </button>
      </div>

      @if (attachedFileContent) {
        <div class="image-chip" style="margin: 0 12px 0 0;">
          @if (isAttachedImage) {
            <img [src]="attachedFileContent | safeUrl" />
            <label style="font-size: 10px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; font-weight: 600; padding-right: 4px;">
              <input type="checkbox" [checked]="shouldAddToAssets()" (change)="shouldAddToAssets.set($any($event.target).checked)">
              Add to assets
            </label>
          } @else {
             <div style="display: flex; align-items: center; gap: 8px; padding: 0 8px; color: var(--text-primary); font-size: 0.8rem; font-weight: 600;">
               <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
               <span style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ attachedFile?.name }}</span>
             </div>
          }
          <button class="chip-remove" (click)="removeAttachment()">√ó</button>
        </div>
      }

      @if (hasFigmaAttachment) {
        <div class="image-chip figma-chip" style="margin: 0 12px 0 0; background: linear-gradient(135deg, rgba(242, 78, 30, 0.1), rgba(162, 89, 255, 0.1)); border-color: rgba(162, 89, 255, 0.3);">
          <div style="display: flex; align-items: center; gap: 8px; padding: 0 8px;">
            <svg viewBox="0 0 38 57" width="16" height="24" fill="none">
              <path fill="#1ABCFE" d="M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/>
              <path fill="#0ACF83" d="M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z"/>
              <path fill="#FF7262" d="M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z"/>
              <path fill="#F24E1E" d="M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z"/>
              <path fill="#A259FF" d="M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z"/>
            </svg>
            <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary);">{{ figmaFrameCount }} Figma frame{{ figmaFrameCount !== 1 ? 's' : '' }}</span>
          </div>
          @if (figmaImages().length > 0) {
            <img [src]="figmaImages()[0] | safeUrl" style="max-height: 32px; border-radius: 4px; margin-left: 4px;" />
          }
          <button class="chip-remove" (click)="removeFigmaAttachment()">√ó</button>
        </div>
      }

      @if (loading()) {
        <button (click)="cancelGeneration()" class="btn-generate btn-cancel" title="Cancel generation">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2.5" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>
        </button>
      } @else {
        <button (click)="generate()" [disabled]="!prompt" class="btn-generate">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        </button>
      }
    </div>
  </div>
}