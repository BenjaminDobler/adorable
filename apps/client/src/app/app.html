<div
  class="app-container"
  [class.selecting]="isSelecting"
  [class.fullscreen]="layoutService.isFullscreen()"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp()"
>
  <aside class="sidebar" [style.width.px]="sidebarWidth()">
    <header class="editor-header">
      <button class="btn-back" (click)="goBack()">
        <svg
          viewBox="0 0 24 24"
          width="16"
          height="16"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </button>
      <div class="project-meta">
        <input [(ngModel)]="projectService.projectName" class="project-name-input" placeholder="Project Name" />
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="status-badge" 
               [class.active]="webContainerService.url()" 
               [class.error]="webContainerService.buildError()">
            {{ webContainerService.status() }}
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button (click)="projectService.migrateProject()" [disabled]="loading() || !projectService.currentFiles()" class="icon-btn" title="Repair Project Configuration">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
        </button>
        <button (click)="saveProject()" [disabled]="loading() || !projectService.currentFiles()" class="icon-btn" title="Save changes">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        </button>
        <button (click)="publish()" [disabled]="loading() || !projectService.currentFiles()" class="icon-btn" title="Publish live site">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1-2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="11" x2="21" y2="3"></line></svg>
        </button>
        <button (click)="downloadZip()" [disabled]="loading() || !projectService.currentFiles()" class="icon-btn" title="Download source">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </button>
      </div>
    </header>

    <div class="chat-section">
      <div class="tab-bar">
        <button class="tab-btn" [class.active]="activeTab() === 'chat'" (click)="activeTab.set('chat')">Chat</button>
        <button class="tab-btn" [class.active]="activeTab() === 'terminal'" (click)="activeTab.set('terminal')">Terminal</button>
        <button class="tab-btn" [class.active]="activeTab() === 'files'" (click)="activeTab.set('files')">Files</button>
      </div>

      @if (activeTab() === 'chat') {
        <app-chat 
          [appSettings]="appSettings" 
          [visualEditorData]="visualEditorData"
          (startSelection)="startSelection()"
          (fileUploaded)="onFileContentChange($event.content, 'public/assets/' + $event.name)"
          (closeVisualEdit)="visualEditorData.set(null)"
        ></app-chat>
      }

      @if (activeTab() === 'terminal') {
        <app-terminal (toggleDebug)="showDebug.set(true)"></app-terminal>
      }

      @if (activeTab() === 'files') {
        <div class="file-explorer-view">
          <div class="upload-action-bar">
             <input type="file" #uploadInput (change)="onUploadFiles($event)" multiple style="display: none" />
             <button class="btn-upload-primary" (click)="uploadInput.click()">
               <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
               Upload Files
             </button>
          </div>
          <app-file-explorer [files]="projectService.allFiles()" (fileSelect)="onFileSelect($event)"></app-file-explorer>
        </div>
      }
    </div>
  </aside>

  <div class="resizer-sidebar" (mousedown)="startSidebarResizing($event)"></div>

  <main class="preview-area">
    <div class="editor-frame-container" [style.display]="activeTab() === 'files' ? 'flex' : 'none'" [style.height.%]="editorHeight()" [style.flex]="'0 0 ' + editorHeight() + '%'">
      @if (selectedFileName()) {
        @if (isImage(selectedFileName())) {
          <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1e1e1e; overflow: auto;">
             <img [src]="selectedFileContent() | safeUrl" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
          </div>
        } @else {
          <app-editor [content]="selectedFileContent()" [fileName]="selectedFileName()" (contentChange)="onFileContentChange($event)"></app-editor>
        }
      } @else {
        <div class="placeholder-state">
          <div class="empty-preview">
            <span class="icon" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 1rem;">
              <svg viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
            </span>
            <h2>Select a file</h2>
            <p>Choose a file from the explorer to view its content.</p>
          </div>
        </div>
      }
    </div>

    <div class="resizer" (mousedown)="startResizing($event)" [style.display]="activeTab() === 'files' ? 'flex' : 'none'">
      <div class="handle"></div>
    </div>

    <div class="preview-wrapper" style="display: flex; flex: 1; flex-direction: column; min-height: 0;">
      @if (webContainerService.url()) {
        <div class="preview-frame-container">
          <div class="preview-toolbar" style="padding: 8px; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: flex-end; gap: 8px; background: var(--bg-color);">
             <button [class.active]="isInspectionActive()" (click)="toggleInspection()" title="Inspect Element" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
               <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
             </button>
             <button [class.active]="layoutService.isFullscreen()" (click)="layoutService.isFullscreen.set(!layoutService.isFullscreen())" title="Toggle Fullscreen" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
               <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
             </button>
             <button (click)="reloadIframe()" title="Refresh Preview" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
               <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
             </button>
          </div>
          <iframe [src]="webContainerService.url() | safeUrl" allow="cross-origin-isolated"></iframe>
        </div>
      } @else {
        <div class="placeholder-state">
          @if (loading()) {
            <div class="construction">
              <div class="spinner-large"></div>
              <h2>Building your app...</h2>
              <p class="loading-text">{{ currentMessage() }}</p>
              <p class="status-detail" style="margin-top: 1rem; font-family: monospace; color: var(--accent-color); background: rgba(62, 207, 142, 0.1); padding: 4px 8px; border-radius: 4px;">
                > {{ webContainerService.status() }}
              </p>
            </div>
          } @else {
            <div class="empty-preview">
              <div class="logo-large">A</div>
              <h2>Ready to generate</h2>
              <p>Describe your app in the sidebar to get started.</p>
            </div>
          }
        </div>
      }
    </div>

    @if (isSelecting && selectionRect) {
      <div class="selection-box" [style.left.px]="selectionRect.x" [style.top.px]="selectionRect.y" [style.width.px]="selectionRect.width" [style.height.px]="selectionRect.height"></div>
    }
  </main>
</div>

@if (showDebug()) {
  <div class="debug-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 99999; padding: 2rem; overflow: auto; font-family: monospace;">
     <div style="background: #1e1e1e; padding: 1.5rem; border-radius: 8px; min-height: 100%; border: 1px solid #333;">
        <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 1rem;">
           <h2 style="margin: 0; color: var(--accent-color);">ðŸ¤– Agent Debug Log</h2>
           <button (click)="showDebug.set(false)" style="background: #333; border: none; color: #fff; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Close (Cmd+Shift+D)</button>
        </div>
        @for (log of debugLogs(); track $index) {
           <div style="border-bottom: 1px solid #333; padding: 0.75rem 0;">
              <div style="color: #888; font-size: 0.8rem; margin-bottom: 4px;">
                <span style="color: var(--text-primary); font-weight: bold;">{{ log.type | uppercase }}</span> 
                - {{ log.timestamp | date:'mediumTime' }}
              </div>
              <pre style="color: #ccc; overflow-x: auto; font-size: 0.85rem; margin: 0; background: #111; padding: 8px; border-radius: 4px;">{{ log | json }}</pre>
           </div>
        }
        @if (debugLogs().length === 0) {
           <div style="color: #666; text-align: center; padding: 2rem;">No logs captured yet. Make a request!</div>
        }
     </div>
  </div>
}