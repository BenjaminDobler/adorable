<div
  class="app-container"
  [class.selecting]="isSelecting"
  [class.fullscreen]="layoutService.isFullscreen()"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp()"
>
  <aside class="sidebar" [style.width.px]="sidebarWidth()">
    <header class="editor-header">
      <button class="btn-back" (click)="goBack()">
        <svg
          viewBox="0 0 24 24"
          width="16"
          height="16"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </button>
      <div class="project-meta">
        <h1>{{ projectName }}</h1>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="status-badge" 
               [class.active]="webContainerService.url()" 
               [class.error]="webContainerService.buildError()"
               (click)="!isAutoFixEnabled() && webContainerService.buildError() ? manualFix() : null"
               [style.cursor]="!isAutoFixEnabled() && webContainerService.buildError() ? 'pointer' : 'default'">
            {{ webContainerService.status() }}
            @if (!isAutoFixEnabled() && webContainerService.buildError()) {
              <span style="margin-left: 4px; text-decoration: underline;">(Click to Fix)</span>
            }
          </div>
          <button (click)="isAutoFixEnabled.set(!isAutoFixEnabled())" 
                  [title]="isAutoFixEnabled() ? 'Auto-Fix Enabled' : 'Auto-Fix Disabled'"
                  style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 4px; display: flex; align-items: center; transition: all 0.2s;">
             <span [style.color]="isAutoFixEnabled() ? 'var(--accent-color)' : 'inherit'" style="font-weight: bold; font-size: 14px;">
                {{ isAutoFixEnabled() ? '⚡' : 'Manual' }}
             </span>
          </button>
        </div>
      </div>
            <div class="header-actions">
              <button (click)="saveProject()" [disabled]="loading() || !currentFiles" class="icon-btn" title="Save changes">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
              </button>
              <button (click)="publish()" [disabled]="loading() || !currentFiles" class="icon-btn" title="Publish live site">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="11" x2="21" y2="3"></line></svg>
              </button>
              <button (click)="downloadZip()" [disabled]="loading() || !currentFiles" class="icon-btn" title="Download source">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              </button>
            </div>
          </header>
      

    <div class="chat-section">
      @if (visualEditorData()) {
        <div class="visual-editor-panel" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; height: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: var(--text-primary);">Visual Edit</h3>
            <button (click)="closeVisualEditor()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">✕</button>
          </div>
          
          <div class="target-card" style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 1rem; border-radius: 8px;">
            <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem;">Target</div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span style="color: var(--accent-color); font-family: monospace;">&lt;{{ visualEditorData().tagName }}&gt;</span>
              @if (visualEditorData().componentName) {
                <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">{{ visualEditorData().componentName }}</span>
              }
            </div>
            @if (visualEditorData().text) {
              <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.875rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                "{{ visualEditorData().text }}"
              </div>
            }
          </div>

          <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="font-size: 0.875rem; font-weight: 500;">What change do you want?</label>
            <textarea 
              [(ngModel)]="visualPrompt" 
              placeholder="e.g. Change text to 'Welcome', make it bold, set background to blue..."
              style="flex: 1; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-primary); padding: 1rem; border-radius: 8px; resize: none;"
            ></textarea>
          </div>

          <button (click)="applyVisualChanges(visualPrompt)" class="btn-generate" style="width: 100%; border-radius: 8px; height: 40px; font-weight: 600;">
            Apply Change
          </button>
        </div>
      } @else {
        <div class="tab-bar">
          <button 
            class="tab-btn" 
            [class.active]="activeTab() === 'chat'" 
            (click)="activeTab.set('chat')">
            Chat
          </button>
          <button 
            class="tab-btn" 
            [class.active]="activeTab() === 'terminal'" 
            (click)="activeTab.set('terminal')">
            Terminal
          </button>
          <button 
            class="tab-btn" 
            [class.active]="activeTab() === 'files'" 
            (click)="activeTab.set('files')">
            Files
          </button>
        </div>

        @if (activeTab() === 'chat') {
          <div class="chat-messages" #scrollContainer>
            @for (msg of messages(); track msg) {
              <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'" [class.system]="msg.role === 'system'">
                <div class="message-content">
                  {{ msg.text }}
                  @if (msg.files) {
                    <div class="message-actions">
                      <button class="btn-restore" (click)="restoreVersion(msg.files)" title="Restore project to this state">
                        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                        Restore this version
                      </button>
                    </div>
                  }
                </div>
                <div class="message-time">{{ msg.timestamp | date:'shortTime' }}</div>
              </div>
            }
            @if (loading()) {
               <div class="message assistant loading">
                 <div class="typing-indicator">
                   <span></span><span></span><span></span>
                 </div>
               </div>
            }
          </div>

          <div class="input-container" 
               [class.dragging]="isDragging"
               (drop)="onDrop($event)"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)">
            
            <textarea 
              [(ngModel)]="prompt" 
              placeholder="Describe what you want to build..."
              [disabled]="loading()"
              (keydown.enter)="$event.preventDefault(); generate()">
            </textarea>
            
            <div class="input-footer">
              <div class="tool-group">
                <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none" />
                <button (click)="fileInput.click()" class="tool-btn" title="Upload Image" [disabled]="loading()">
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <button (click)="startSelection()" class="tool-btn" title="Select Area to Edit" [disabled]="!webContainerService.url()">
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                </button>
              </div>

              @if (attachedImage) {
                <div class="image-chip">
                  <img [src]="attachedImage | safeUrl" />
                  <button class="chip-remove" (click)="removeAttachment()">×</button>
                </div>
              }

              <button (click)="generate()" [disabled]="loading() || !prompt" class="btn-generate">
                @if (loading()) {
                  <div class="spinner-small"></div>
                } @else {
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                }
              </button>
            </div>
          </div>
        }

        @if (activeTab() === 'terminal') {
                <div class="terminal-view">
                  <div class="terminal-header">
                    <button
                      class="btn-clear"
                      (click)="webContainerService.output.set('')"
                    >
                      Clear
                    </button>
                  </div>
                  <div class="terminal-window">
                    <code [innerHTML]="webContainerService.output() | terminalFormat"></code>
                  </div>
                </div>
          
        }

        @if (activeTab() === 'files') {
          <div class="file-explorer-view">
            <app-file-explorer [files]="allFiles" (fileSelect)="onFileSelect($event)"></app-file-explorer>
          </div>
        }
      }
    </div>
  </aside>

  <div class="resizer-sidebar" (mousedown)="startSidebarResizing($event)"></div>

  <main class="preview-area">
    <div
      class="editor-frame-container"
      [style.display]="activeTab() === 'files' ? 'flex' : 'none'"
      [style.height.%]="editorHeight()"
      [style.flex]="'0 0 ' + editorHeight() + '%'"
    >
      @if (selectedFileName()) {

      <app-editor
        [content]="selectedFileContent()"
        [fileName]="selectedFileName()"
        (contentChange)="onFileContentChange($event)"
      >
      </app-editor>

      } @else {

      <div class="placeholder-state">
        <div class="empty-preview">
          <span
            class="icon"
            style="
              font-size: 2rem;
              color: var(--text-secondary);
              margin-bottom: 1rem;
            "
          >
            <svg
              viewBox="0 0 24 24"
              width="48"
              height="48"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
              ></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
          </span>

          <h2>Select a file</h2>

          <p>Choose a file from the explorer to view its content.</p>
        </div>
      </div>

      }
    </div>

    <div 
      class="resizer" 
      (mousedown)="startResizing($event)"
      [style.display]="activeTab() === 'files' ? 'flex' : 'none'">
      <div class="handle"></div>
    </div>

    <div
      class="preview-wrapper"
      style="display: flex; flex: 1; flex-direction: column; min-height: 0;"
    >
      @if (webContainerService.url()) {

      <div class="preview-frame-container">
        <div class="preview-toolbar" style="padding: 8px; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: flex-end; gap: 8px; background: var(--bg-color);">
           <button [class.active]="isInspectionActive()" (click)="toggleInspection()" title="Inspect Element" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
             <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
           </button>
           <button [class.active]="layoutService.isFullscreen()" (click)="layoutService.isFullscreen.set(!layoutService.isFullscreen())" title="Toggle Fullscreen" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
             <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
           </button>
           <button (click)="reloadIframe()" title="Refresh Preview" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 4px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-secondary); transition: all 0.2s;">
             <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
           </button>
        </div>
        <iframe [src]="webContainerService.url() | safeUrl" allow="cross-origin-isolated"></iframe>
      </div>

      } @else {

      <div class="placeholder-state">
        @if (loading()) {

        <div class="construction">
          <div class="spinner-large"></div>

          <h2>Building your app...</h2>

          <p class="loading-text">{{ currentMessage() }}</p>
        </div>

        } @else {

        <div class="empty-preview">
          <div class="logo-large">A</div>

          <h2>Ready to generate</h2>

          <p>Describe your app in the sidebar to get started.</p>
        </div>

        }
      </div>

      }
    </div>

    <!-- Marquee Overlay -->

    @if (isSelecting && selectionRect) {

    <div
      class="selection-box"
      [style.left.px]="selectionRect.x"
      [style.top.px]="selectionRect.y"
      [style.width.px]="selectionRect.width"
      [style.height.px]="selectionRect.height"
    ></div>

    }
  </main>
</div>
