<div class="app-container" 
     [class.selecting]="isSelecting"
     (mousedown)="onMouseDown($event)"
     (mousemove)="onMouseMove($event)"
     (mouseup)="onMouseUp()">
  
  <div class="sidebar">
    <div class="header">
      <h1>Adorable</h1>
      <p>Angular App Generator</p>
      @if (userProfile()) {
        <div class="user-badge">Hello, {{ userProfile().name }}</div>
      }
    </div>
    
    <div class="chat-area">
      <div class="project-controls">
        <input 
          type="text" 
          [(ngModel)]="projectName" 
          placeholder="Project Name" 
          [disabled]="loading()"
          class="project-name-input"
        />
        <button (click)="saveProject()" [disabled]="loading() || !projectName || !currentFiles" class="icon-btn" title="Save Project">
          üíæ
        </button>
        <button (click)="downloadZip()" [disabled]="loading() || !currentFiles" class="icon-btn" title="Download ZIP">
          ‚¨áÔ∏è
        </button>
        <div class="dropdown">
          <button (click)="toggleLoadMenu()" class="icon-btn" title="Load Project">
            üìÇ
          </button>
          @if (showLoadMenu) {
            <div class="dropdown-content">
              @for (proj of projects(); track proj) {
                <div (click)="loadProject(proj)" class="dropdown-item">{{ proj }}</div>
              } @empty {
                <div class="dropdown-item disabled">No saved projects</div>
              }
            </div>
          }
        </div>
        <button (click)="toggleSettings()" class="icon-btn" title="Settings">
          ‚öôÔ∏è
        </button>
        <button (click)="showProfile = true" class="icon-btn" title="Profile">
          üë§
        </button>
      </div>

      <div class="input-wrapper">
        <textarea 
          [(ngModel)]="prompt" 
          placeholder="e.g., Create a todo list with signals and tailwind..."
          [disabled]="loading()">
        </textarea>
        
        <div class="toolbar">
          <button (click)="startSelection()" class="icon-btn small" title="Select Area to Edit" [disabled]="!webContainerService.url()">
            ‚õ∂
          </button>
        </div>

        @if (attachedImage) {
          <div class="attachment-preview">
            <img [src]="attachedImage | safeUrl" />
            <button class="remove-btn" (click)="removeAttachment()">√ó</button>
          </div>
        }
      </div>

      <button (click)="generate()" [disabled]="loading() || !prompt" class="generate-btn">
        {{ loading() ? 'Generating...' : 'Generate App' }}
      </button>
    </div>

    @if (showSettings) {
      <app-settings 
        (close)="showSettings = false"
        (save)="onSettingsSaved($event)">
      </app-settings>
    }

    @if (showProfile) {
      <app-profile 
        [user]="userProfile()"
        (close)="showProfile = false"
        (save)="onProfileSaved($event)">
      </app-profile>
    }

    <div class="terminal-container">
      <h3>Terminal Output</h3>
      <pre class="terminal"><code>{{ webContainerService.output() }}</code></pre>
    </div>
  </div>

  <div class="preview-area">
    @if (webContainerService.url()) {
      <iframe [src]="webContainerService.url() | safeUrl"></iframe>
    } @else {
      <div class="placeholder">
        @if (loading()) {
          <div class="spinner"></div>
          <p>Your generated app will appear here.</p>
        } @else {
          <p>Your generated app will appear here.</p>
        }
      </div>
    }
    
    <!-- Marquee Overlay -->
    @if (isSelecting && selectionRect) {
      <div class="selection-box" [style.left.px]="selectionRect.x" [style.top.px]="selectionRect.y" [style.width.px]="selectionRect.width" [style.height.px]="selectionRect.height"></div>
    }
  </div>
</div>