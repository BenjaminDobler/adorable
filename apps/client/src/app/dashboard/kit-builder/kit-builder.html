@if (showFolderImport()) {
  <app-folder-import
    (import)="onFolderImport($event)"
    (cancel)="showFolderImport.set(false)">
  </app-folder-import>
} @else {
  <div class="kit-builder-page">
    <div class="kit-builder-content">
      <div class="page-header">
        <button class="btn-back" (click)="goBack()">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Back to Kits
        </button>
        <h2>{{ kit ? 'Edit Starter Kit' : 'Create Starter Kit' }}</h2>
      </div>

      @if (loading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      } @else {
        <div class="kit-builder">
          <div class="form-section">
            <div class="form-group">
              <label>Kit Name <span class="required">*</span></label>
              <input
                type="text"
                [ngModel]="kitName()"
                (ngModelChange)="kitName.set($event)"
                placeholder="e.g., LeanIX Starter"
              />
            </div>

            <div class="form-group">
              <label>Description</label>
              <input
                type="text"
                [ngModel]="kitDescription()"
                (ngModelChange)="kitDescription.set($event)"
                placeholder="e.g., Enterprise Angular starter"
              />
            </div>
          </div>

          <div class="form-section">
            <h4>Template</h4>
            <div class="template-options">
              <label class="template-option" [class.selected]="templateType() === 'default'">
                <input
                  type="radio"
                  name="templateType"
                  [checked]="templateType() === 'default'"
                  (change)="setTemplateType('default')"
                />
                <span class="option-content">
                  <span class="option-title">Use Default (Angular 21)</span>
                  <span class="option-desc">Blank Angular 21 project with standalone components</span>
                </span>
              </label>
              <label class="template-option" [class.selected]="templateType() === 'custom'">
                <input
                  type="radio"
                  name="templateType"
                  [checked]="templateType() === 'custom'"
                  (change)="setTemplateType('custom')"
                />
                <span class="option-content">
                  <span class="option-title">Custom Template</span>
                  <span class="option-desc">Import from local folder</span>
                </span>
              </label>
            </div>

            @if (templateType() === 'custom') {
              <div class="custom-template-actions">
                <button class="btn-import-folder" (click)="openFolderImport()">
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                  </svg>
                  {{ importedFileCount() > 0 ? 'Re-import from Folder...' : 'Import from Folder...' }}
                </button>
                @if (importedFileCount() > 0) {
                  <span class="template-status">{{ importedFileCount() }} files imported</span>
                  <button class="btn-toggle-tree" (click)="showTemplateTree.set(!showTemplateTree())">
                    {{ showTemplateTree() ? 'Hide Files' : 'Edit Files' }}
                  </button>
                }
              </div>

              @if (showTemplateTree() && importedFileCount() > 0) {
                <div class="template-tree-editor">
                  <div class="tree-toolbar">
                    <span class="tree-file-count">{{ importedFileCount() }} files</span>
                    <div class="tree-toolbar-actions">
                      <button class="btn-tree-action" (click)="expandAllTemplateFolders()">Expand All</button>
                      <button class="btn-tree-action" (click)="collapseAllTemplateFolders()">Collapse All</button>
                    </div>
                  </div>
                  <div class="template-file-list">
                    @for (entry of visibleTemplateEntries(); track entry.path) {
                      <div
                        class="template-file-item"
                        [class.is-directory]="entry.isDirectory"
                        [style.padding-left.px]="12 + entry.depth * 20"
                      >
                        @if (entry.isDirectory) {
                          <button class="btn-chevron" [class.expanded]="expandedTemplatePaths().has(entry.path)" (click)="toggleTemplateFolder(entry.path)">
                            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
                              <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                          </button>
                          <svg class="entry-icon" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                          </svg>
                        } @else {
                          <span class="chevron-spacer"></span>
                          <svg class="entry-icon" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                          </svg>
                        }
                        <span class="entry-name">{{ entry.name }}</span>
                        @if (!entry.isDirectory && entry.size > 0) {
                          <span class="entry-size">{{ formatFileSize(entry.size) }}</span>
                        }
                        <button
                          class="btn-remove-entry"
                          (click)="entry.isDirectory ? removeTemplateFolder(entry.path) : removeTemplateFile(entry.path)"
                          [title]="entry.isDirectory ? 'Remove folder and contents' : 'Remove file'"
                        >
                          <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>

          <div class="form-section">
            <h4>Component Library (Optional)</h4>

            <!-- Added packages list -->
            @if (npmPackages().length > 0) {
              <div class="packages-list">
                <label class="packages-label">Packages</label>
                @for (pkg of npmPackages(); track pkg.name) {
                  <div class="package-item">
                    <span class="package-name">{{ pkg.name }}</span>
                    <select
                      class="package-suffix"
                      [ngModel]="pkg.importSuffix"
                      (ngModelChange)="updatePackageSuffix($index, $event)"
                    >
                      <option value="Component">Component</option>
                      <option value="Directive">Directive</option>
                      <option value="">None</option>
                      <option value="Module">Module</option>
                    </select>
                    <button class="btn-remove-package" (click)="removePackage($index)" title="Remove package">×</button>
                  </div>
                }
              </div>
            }

            <!-- Add package / discover -->
            <div class="npm-discovery">
              <div class="form-group">
                <label>{{ npmPackages().length > 0 ? 'Add Another Package' : 'npm Package' }}</label>
                <div class="npm-input-row">
                  <input
                    type="text"
                    [ngModel]="newPackageName()"
                    (ngModelChange)="newPackageName.set($event)"
                    placeholder="e.g., @fundamental-ngx/core"
                    [disabled]="discovering()"
                  />
                  <select
                    class="suffix-select"
                    [ngModel]="newPackageSuffix()"
                    (ngModelChange)="newPackageSuffix.set($event)"
                  >
                    <option value="Component">Component</option>
                    <option value="Directive">Directive</option>
                    <option value="">None</option>
                    <option value="Module">Module</option>
                  </select>
                  <button
                    class="btn-discover"
                    (click)="discoverFromNpm()"
                    [disabled]="discovering() || !newPackageName()"
                  >
                    {{ discovering() ? 'Discovering...' : 'Discover & Add' }}
                  </button>
                </div>
                <span class="hint">Enter the npm package name to discover components and add to the kit</span>
              </div>
            </div>

            @if (discoveryError()) {
              <div class="error-message">
                {{ discoveryError() }}
              </div>
            }

            <!-- Optional: Storybook for additional info -->
            @if (discoveredComponents().length > 0) {
              <details class="storybook-optional">
                <summary>Storybook URL (optional)</summary>
                <div class="storybook-content">
                  <div class="form-group">
                    <input
                      type="url"
                      [ngModel]="storybookUrl()"
                      (ngModelChange)="storybookUrl.set($event)"
                      placeholder="https://storybook.example.com"
                    />
                    <span class="hint">Add Storybook URL to link to documentation pages</span>
                  </div>
                </div>
              </details>
            }

            @if (discoveredComponents().length > 0) {
              <div class="components-section">
                <div class="components-header">
                  <div class="components-info">
                    <span class="success-icon">✓</span>
                    Found {{ totalCount() }} components
                    <span class="selected-count">({{ selectedCount() }} selected)</span>
                  </div>
                  <div class="components-actions">
                    <input
                      type="text"
                      class="filter-input"
                      [ngModel]="filterText()"
                      (ngModelChange)="filterText.set($event)"
                      placeholder="Filter components..."
                    />
                    <label class="select-all-toggle">
                      <input
                        type="checkbox"
                        [checked]="selectAll()"
                        (change)="toggleSelectAll()"
                      />
                      Select All
                    </label>
                  </div>
                </div>

                <div class="components-list">
                  @for (entry of componentsByCategory() | keyvalue; track entry.key) {
                    <div class="category-group">
                      <div class="category-name">{{ entry.key }}</div>
                      <div class="category-components">
                        @for (component of entry.value; track component.id) {
                          <div class="component-item-wrapper" [class.selected]="isSelected(component.id)">
                            <label class="component-item">
                              <input
                                type="checkbox"
                                [checked]="isSelected(component.id)"
                                (change)="toggleComponent(component.id)"
                              />
                              <span class="component-name">{{ component.componentName || component.title }}</span>
                              @if (component.sourcePackage && npmPackages().length > 1) {
                                <span class="package-badge" [title]="component.sourcePackage">{{ component.sourcePackage.split('/').pop() }}</span>
                              }
                              @if (hasStoredDocs(component)) {
                                <span class="has-docs-badge" title="Has custom documentation">✓</span>
                              }
                            </label>
                            <button
                              class="btn-edit-component"
                              (click)="openComponentEditor(component, $event)"
                              title="Edit component documentation"
                            >
                              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <app-adorable-file-browser
            [kitId]="kitId"
            [hasDiscoveredComponents]="discoveredComponents().length > 0"
          />

          <div class="form-section">
            <h4>System Prompt (Optional)</h4>
            <p class="section-hint">Custom instructions the AI will follow when generating code with this kit. Use this to encode usage rules, coding conventions, or architectural guidance.</p>
            <div class="form-group">
              <textarea
                [ngModel]="kitSystemPrompt()"
                (ngModelChange)="kitSystemPrompt.set($event)"
                placeholder="e.g., Always use reactive forms. Prefer OnPush change detection. Use the Button component instead of native buttons..."
                rows="5"
              ></textarea>
            </div>

            <details class="base-prompt-override" [attr.open]="showBasePromptOverride() ? '' : null">
              <summary (click)="$event.preventDefault(); toggleBasePromptOverride()">Advanced: Override Base System Prompt</summary>
              @if (showBasePromptOverride()) {
                <div class="base-prompt-content">
                  <div class="base-prompt-warning">
                    This replaces the default system prompt entirely. The default is shown below as a starting point. Only override if you know what you're doing.
                  </div>
                  <div class="form-group">
                    <div class="base-prompt-actions">
                      @if (kitBaseSystemPrompt() !== defaultSystemPrompt()) {
                        <button type="button" class="btn-reset-prompt" (click)="kitBaseSystemPrompt.set(defaultSystemPrompt())">Reset to Default</button>
                      }
                    </div>
                    <textarea
                      [ngModel]="kitBaseSystemPrompt()"
                      (ngModelChange)="kitBaseSystemPrompt.set($event)"
                      placeholder="Enter a complete system prompt to replace the default..."
                      rows="20"
                      class="monospace-textarea"
                    ></textarea>
                  </div>
                </div>
              }
            </details>
          </div>

          <app-tool-tester
            [kitId]="kitId"
            [hasComponents]="discoveredComponents().length > 0"
          />

          @if (mcpServers.length > 0) {
            <div class="form-section">
              <h4>MCP Servers (Optional)</h4>
              <p class="section-hint">Select MCP servers that should be active when this kit is used</p>
              <div class="mcp-server-list">
                @for (server of mcpServers; track server.id) {
                  <label class="mcp-server-item" [class.selected]="isMcpServerSelected(server.id)">
                    <input
                      type="checkbox"
                      [checked]="isMcpServerSelected(server.id)"
                      (change)="toggleMcpServer(server.id)"
                    />
                    <span class="server-name">{{ server.name }}</span>
                  </label>
                }
              </div>
            </div>
          }

          <div class="form-actions">
            <button class="btn-cancel" (click)="goBack()" [disabled]="saving()">
              Cancel
            </button>
            <button
              class="btn-save"
              (click)="saveKit()"
              [disabled]="saving() || !kitName()"
            >
              {{ saving() ? 'Saving...' : (kit ? 'Save Changes' : 'Save Kit') }}
            </button>
          </div>
        </div>
      }
    </div>

    <app-component-editor-modal
      [component]="editingComponent()"
      (saved)="onComponentSaved($event)"
      (closed)="closeComponentEditor()"
    />
  </div>
}
