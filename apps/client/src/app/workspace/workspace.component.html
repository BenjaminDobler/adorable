<div
  class="app-container"
  [class.selecting]="isSelecting"
  [class.fullscreen]="layoutService.isFullscreen()"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp()"
>
  <aside class="sidebar" [style.width.px]="sidebarWidth()" [class.popover-open]="sidebarPopoverOpen()">
    <div class="chat-section">
      <div class="tab-bar">
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'chat'"
          (click)="activeTab.set('chat')"
        >
          Chat
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'terminal'"
          (click)="activeTab.set('terminal')"
        >
          Terminal
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'files'"
          (click)="activeTab.set('files')"
        >
          Files
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'figma'"
          (click)="activeTab.set('figma')"
        >
          Figma
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'versions'"
          (click)="activeTab.set('versions')"
        >
          Versions
        </button>
      </div>

      @if (activeTab() === 'chat') {
      <app-chat
        [appSettings]="appSettings"
        [visualEditorData]="visualEditorData"
        [pendingFigmaImport]="pendingFigmaImport()"
        (fileUploaded)="onFileContentChange($event.content, 'public/assets/' + $event.name)"
        (figmaImportProcessed)="pendingFigmaImport.set(null)"
        (popoverToggled)="sidebarPopoverOpen.set($event)"
      ></app-chat>
      } @if (activeTab() === 'terminal') {
      <app-terminal (toggleDebug)="showDebug.set(true)"></app-terminal>
      }
      <div class="file-explorer-view" [hidden]="activeTab() !== 'files'">
        <div class="upload-action-bar">
          <input
            type="file"
            #uploadInput
            (change)="onUploadFiles($event)"
            multiple
            style="display: none"
          />
          <button class="btn-upload-primary" (click)="uploadInput.click()">
            <svg
              viewBox="0 0 24 24"
              width="16"
              height="16"
              stroke="currentColor"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Upload Files
          </button>
        </div>
        <app-file-explorer
          [files]="projectService.files()"
          (fileSelect)="onFileSelect($event)"
          (fileAction)="onFileAction($event)"
        ></app-file-explorer>
      </div>
      @if (activeTab() === 'figma') {
      <app-figma-panel
        [storedImports]="projectService.figmaImports()"
        (importToChat)="onFigmaImport($event)"
        (importsChanged)="onFigmaImportsChanged($event)"
      ></app-figma-panel>
      }
      @if (activeTab() === 'versions') {
      <app-versions-panel></app-versions-panel>
      }
    </div>

    @if (visualEditorData()) {
      <div class="visual-editor-overlay">
        <app-visual-editor-panel
          [visualEditorData]="visualEditorData"
          (closeEditor)="visualEditorData.set(null)"
          (aiChangeRequested)="onVisualEditAiChange($event)">
        </app-visual-editor-panel>
      </div>
    }
  </aside>

  <div class="resizer-sidebar" (mousedown)="startSidebarResizing($event)"></div>

  <main class="preview-area">
    <div
      class="editor-frame-container"
      [style.display]="activeTab() === 'files' ? 'flex' : 'none'"
      [style.height.%]="editorHeight()"
      [style.flex]="'0 0 ' + editorHeight() + '%'"
    >
      @if (selectedFileName()) { @if (isImage(selectedFileName())) {
      <div
        style="
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #1e1e1e;
          overflow: auto;
        "
      >
        <img
          [src]="selectedFileContent() | safeUrl"
          style="max-width: 100%; max-height: 100%; object-fit: contain"
        />
      </div>
      } @else {
      <app-editor
        [content]="selectedFileContent()"
        [fileName]="selectedFileName()"
        (contentChange)="onFileContentChange($event)"
      ></app-editor>
      } } @else {
      <div class="placeholder-state">
        <div class="empty-preview">
          <span
            class="icon"
            style="
              font-size: 2rem;
              color: var(--text-secondary);
              margin-bottom: 1rem;
            "
          >
            <svg
              viewBox="0 0 24 24"
              width="48"
              height="48"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
              ></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
          </span>
          <h2>Select a file</h2>
          <p>Choose a file from the explorer to view its content.</p>
        </div>
      </div>
      }
    </div>

    <div
      class="resizer"
      (mousedown)="startResizing($event)"
      [style.display]="activeTab() === 'files' ? 'flex' : 'none'"
    >
      <div class="handle"></div>
    </div>

    <div
      class="preview-wrapper"
      style="display: flex; flex: 1; flex-direction: column; min-height: 0"
    >
      @if (containerEngine.url()) {
      <div class="preview-frame-container" [class]="'device-' + previewDevice()">
        <app-preview-toolbar
          [previewDevice]="previewDevice()"
          [isInspectionActive]="isInspectionActive()"
          [isAnnotating]="isAnnotating()"
          [isFullscreen]="layoutService.isFullscreen()"
          (previewDeviceChange)="previewDevice.set($event)"
          (inspectionToggled)="toggleInspection()"
          (annotationToggled)="toggleAnnotation()"
          (screenshotRequested)="startSelection()"
          (fullscreenToggled)="layoutService.isFullscreen.set(!layoutService.isFullscreen())"
          (reload)="reloadIframe()"
        />
        <div class="iframe-wrapper">
          <iframe
            #previewFrame
            [src]="containerEngine.url() | safeUrl"
            [style.pointer-events]="isResizingSidebar || isResizingEditor || isAnnotating() || isSelecting ? 'none' : 'auto'"
          ></iframe>
        </div>
        <app-annotation-overlay
          [active]="isAnnotating()"
          (done)="onAnnotationDone($event)"
          (cancelled)="isAnnotating.set(false)"
        />
      </div>
      } @else {
      <div class="placeholder-state">
        <div class="construction">
          <div class="spinner-large"></div>
          <h2>Building your app...</h2>
          <p class="loading-text">{{ currentMessage() }}</p>
          <p class="status-detail">
            > {{ containerEngine.status() }}
          </p>
        </div>
      </div>
      }
    </div>

    @if (isSelecting && selectionRect) {
    <div
      class="selection-box"
      [style.left.px]="selectionRect.x"
      [style.top.px]="selectionRect.y"
      [style.width.px]="selectionRect.width"
      [style.height.px]="selectionRect.height"
    ></div>
    }
  </main>
</div>

<app-debug-overlay
  [logs]="debugLogs()"
  [visible]="showDebug()"
  (closed)="showDebug.set(false)"
/>