name: Build Desktop App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      build_mac:
        description: 'Build for macOS'
        required: true
        default: true
        type: boolean
      build_windows:
        description: 'Build for Windows'
        required: true
        default: true
        type: boolean
      build_linux:
        description: 'Build for Linux'
        required: true
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean

jobs:
  build-mac:
    if: ${{ inputs.build_mac }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build and package for macOS
        run: npm run package:desktop:mac -- --publish never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adorable-macos
          path: |
            dist/desktop-release/*.dmg
            dist/desktop-release/*.zip
          if-no-files-found: error

  build-windows:
    if: ${{ inputs.build_windows }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build and package for Windows
        run: npm run package:desktop:win -- --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adorable-windows
          path: |
            dist/desktop-release/*.exe
            dist/desktop-release/*.msi
          if-no-files-found: warn

  build-linux:
    if: ${{ inputs.build_linux }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build and package for Linux
        run: npm run package:desktop:linux -- --publish never

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adorable-linux
          path: |
            dist/desktop-release/*.AppImage
            dist/desktop-release/*.deb
            dist/desktop-release/*.rpm
          if-no-files-found: warn

  release:
    needs: [build-mac, build-windows, build-linux]
    # Run even if some builds were skipped (but not if they failed)
    if: |
      always() &&
      inputs.create_release &&
      (needs.build-mac.result == 'success' || needs.build-mac.result == 'skipped') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') &&
      !(needs.build-mac.result == 'skipped' && needs.build-windows.result == 'skipped' && needs.build-linux.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package Chrome Extension
        run: |
          cd apps/extensions/adorable-screenshot
          zip -r ../../../adorable-screenshot-extension.zip .
          cd ../../..

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Adorable v${{ inputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/adorable-macos/*
            artifacts/adorable-windows/*
            artifacts/adorable-linux/*
            adorable-screenshot-extension.zip
